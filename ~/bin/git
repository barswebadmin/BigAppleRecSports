#!/bin/bash

# Smart git wrapper that auto-handles formatting fixes on commit
# This script intercepts `git commit` commands and auto-fixes formatting issues

if [[ "$1" == "commit" ]]; then
    shift  # Remove "commit" from arguments

    echo "ğŸš€ Attempting git commit..."

    # Try the commit
    if /usr/bin/git commit "$@"; then
        echo "âœ… Commit successful!"
        exit 0
    else
        commit_exit_code=$?
        echo "ğŸ”§ Commit failed, checking if it was just formatting..."

        # Check if there are unstaged changes (likely from pre-commit auto-fixes)
        if /usr/bin/git status --porcelain | grep -q "^[ M]M"; then
            echo "ğŸ“ Found auto-fixed formatting changes, staging and retrying..."
            /usr/bin/git add .
            echo "ğŸ¯ Re-attempting commit..."
            /usr/bin/git commit "$@"
            echo "âœ… Commit completed after auto-fixing formatting!"
        else
            echo "âŒ Commit failed for non-formatting reasons (exit code: $commit_exit_code)"
            exit $commit_exit_code
        fi
    fi
else
    # For all other git commands, pass through to real git
    exec /usr/bin/git "$@"
fi
