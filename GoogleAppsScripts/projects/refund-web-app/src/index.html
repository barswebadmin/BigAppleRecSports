<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Refund Web App</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
      label { display: block; margin: 8px 0 4px; }
      input { width: 100%; padding: 8px; font-size: 16px; }
      button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
      .row { display: flex; gap: 8px; }
      .row > * { flex: 1; }
      .muted { color: #666; font-size: 14px; }
      .error { color: #b00020; }
      .success { color: #0a7a0a; }
      .hidden { display: none; }
    </style>
    <script>
      function byId(id){ return document.getElementById(id); }
      function show(el, yes){ el.classList.toggle('hidden', !yes); }
      function text(el, t){ el.textContent = t; }

      function onQuoteSubmit(e){
        e.preventDefault();
        var email = byId('email').value.trim();
        var order = byId('order').value.trim();
        var msg = byId('quoteMsg');
        text(msg, 'Submitting...'); msg.className = 'muted';

        google.script.run
          .withSuccessHandler(function(data){
            text(msg, 'Quote ready.'); msg.className = 'success';
            byId('quoteResult').innerHTML = '' +
              '<p><strong>Eligible:</strong> ' + (data.eligible ? 'Yes' : 'No') + '</p>' +
              '<p><strong>Refund Amount:</strong> $' + Number(data.refund_amount).toFixed(2) + '</p>';
            text(byId('quoteDetails'), data.reason || '');
            byId('acceptPayload').value = JSON.stringify({
              email: email,
              order_number: order,
              quote_id: data.quote_id
            });
            show(byId('quoteCard'), true);
            try {
              var pretty = JSON.stringify(data, null, 2);
              var w = window.open('', 'quotePopup', 'width=600,height=500');
              if (w) {
                w.document.write('<!doctype html><html><head><title>Quote Result</title>' +
                  '<style>body{font-family:monospace;white-space:pre-wrap;margin:16px;} h1{font-family:system-ui,sans-serif;}</style>' +
                  '</head><body><h1>Quote Result</h1><pre>' +
                  pretty.replace(/[&<>]/g, function(ch){return ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]);}) +
                  '</pre></body></html>');
                w.document.close();
              } else {
                alert(pretty);
              }
            } catch (e) {
              // fallback no-op
            }
          })
          .withFailureHandler(function(err){
            msg.className = 'error'; text(msg, err && err.message ? err.message : 'Error getting quote');
          })
          .getRefundQuote(email, order);
      }

      function onAccept(){
        var payload;
        try {
          payload = JSON.parse(byId('acceptPayload').value);
        } catch(e){
          text(byId('processMsg'), 'Invalid quote context');
          byId('processMsg').className = 'error';
          return;
        }
        var msg = byId('processMsg');
        text(msg, 'Processing...'); msg.className = 'muted';
        google.script.run
          .withSuccessHandler(function(data){
            msg.className = 'success';
            text(msg, 'Refund processed. Reference: ' + (data.refund_id || 'N/A'));
          })
          .withFailureHandler(function(err){
            msg.className = 'error'; text(msg, err && err.message ? err.message : 'Error processing refund');
          })
          .processRefund(payload);
      }
    </script>
  </head>
  <body>
    <h1>Refund Request</h1>
    <form onsubmit="onQuoteSubmit(event)">
      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" required />
        </div>
        <div>
          <label for="order">Order Number</label>
          <input id="order" type="text" required />
        </div>
      </div>
      <button type="submit">Check Refund</button>
      <div id="quoteMsg" class="muted" style="margin-top:8px;"></div>
    </form>

    <div id="quoteCard" class="card hidden">
      <h2>Refund Summary</h2>
      <div id="quoteResult"></div>
      <div id="quoteDetails" class="muted"></div>
      <input id="acceptPayload" type="hidden" />
      <div style="margin-top:12px;">
        <button type="button" onclick="onAccept()">Accept & Process Refund</button>
      </div>
      <div id="processMsg" style="margin-top:8px;"></div>
    </div>
  </body>
  
</html>


