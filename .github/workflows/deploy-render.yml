name: Deploy to Render


on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing backend dependencies..."
        cd backend
        pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org -r requirements.txt

    - name: Run backend tests
      run: |
        echo "ğŸ§ª Running backend tests before deployment..."
        cd backend

        # Set test environment variables
        export SHOPIFY_STORE="test-store.myshopify.com"
        export SHOPIFY_TOKEN="test_token"
        export ENVIRONMENT="test"
        export SLACK_REFUNDS_BOT_TOKEN="test_slack_token"

        echo "ğŸ§ª Test environment setup:"
        echo "  ENVIRONMENT=$ENVIRONMENT"
        echo "  SHOPIFY_STORE=$SHOPIFY_STORE"

        python -m pytest tests/unit/ -v
        python -m pytest services/*/tests/ -v || true
        python -m pytest routers/tests/ -v || true
        echo "âœ… Tests completed"
      env:
        SHOPIFY_STORE: test-store.myshopify.com
        SHOPIFY_TOKEN: test_token
        ENVIRONMENT: test
        SLACK_REFUNDS_BOT_TOKEN: test_slack_token

    - name: Trigger Render Deployment
      run: |
        echo "ğŸš€ Triggering Render deployment..."
        echo "ğŸ“‹ Deployment Details:"
        echo "  - Environment: ${{ github.event.inputs.environment }}"
        echo "  - Reason: ${{ github.event.inputs.reason }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Trigger: ${{ github.event_name }}"

        # Trigger Render deployment via their webhook
        if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "ref": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "environment": "${{ github.event.inputs.environment }}",
              "reason": "${{ github.event.inputs.reason }}"
            }'
          echo "âœ… Render deployment webhook triggered"
        else
          echo "âš ï¸ RENDER_DEPLOY_HOOK_URL secret not set"
          echo "â„¹ï¸ You can find your deploy hook URL in Render dashboard under Settings > Build & Deploy"
          echo "â„¹ï¸ Add it as a repository secret: RENDER_DEPLOY_HOOK_URL"
        fi

    - name: Deployment Summary
      run: |
        echo "ğŸ“Š === DEPLOYMENT SUMMARY ==="
        echo "ğŸŒ Service: bars-backend"
        echo "ğŸ¯ Environment: ${{ github.event.inputs.environment }}"
        echo "ğŸ”§ Reason: ${{ github.event.inputs.reason }}"
        echo "ğŸ“± Branch: ${{ github.ref_name }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ• Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ”„ Trigger type: ${{ github.event_name }}"
        echo "=========================="
