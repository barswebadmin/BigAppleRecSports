name: Compilation Check

on:
  # Only run on PRs targeting main (use pull_request_target to ensure base workflow is used), and on direct pushes to main
  pull_request_target:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

# Minimal permissions for safety with pull_request_target
permissions:
  contents: read
  pull-requests: read

# Prevent duplicate runs: use branch name for consistency across push/PR events
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  compilation-check:
    runs-on: ubuntu-latest

    outputs:
      backend-compiled: ${{ steps.backend-compile.outputs.success }}
      gas-compiled: ${{ steps.gas-compile.outputs.success }}
      lambda-compiled: ${{ steps.lambda-compile.outputs.success }}

    steps:
    - uses: actions/checkout@v4
      with:
        # Ensure we test the PR code, not base, when using pull_request_target
        ref: ${{ github.event.pull_request.head.sha }}

    # Backend Compilation Check
    - name: Check Backend Compilation
      id: backend-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Backend compilation..."

        # Set up Python and install backend requirements
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

        cd backend

        # Set minimal environment variables for compilation
        export SHOPIFY_STORE_ID="test-store-id"
        export shopify/token.admin="test_token"
        export SHOPIFY_LOCATION_ID="test-location-id"
        export ENVIRONMENT="test"
        export SLACK_BOT_TOKEN_REFUNDS="test_slack_token"

        # Check if Python files compile without syntax errors
        echo "ðŸ“‹ Checking Python syntax..."
        python -m py_compile config.py
        python -m py_compile main.py

        # Check if modules can be imported (basic compilation check)
        echo "ðŸ“‹ Checking module imports..."
        python -c "
        import sys
        sys.path.append('.')
        try:
            from config import settings
            print('âœ… Config module imports successfully')
            from main import app
            print('âœ… Main FastAPI app imports successfully')
            from modules.orders import OrdersService
            print('âœ… Orders service imports successfully')
            from modules.integrations.slack import SlackClient
            print('âœ… Slack Client imports successfully')
            from routers.refunds import router as refunds_router
            print('âœ… Refunds router imports successfully')
            print('âœ… Backend compilation successful!')
        except Exception as e:
            print(f'âŒ Backend compilation failed: {e}')
            sys.exit(1)
        "

        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Backend compilation check passed"

    - name: Check Google Apps Scripts Compilation
      id: gas-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Google Apps Scripts compilation..."
        cd GoogleAppsScripts

        # Set up Node.js for GAS testing
        npm install -g @google/clasp || true

        # Validate JSON manifests
        echo "ðŸ“‹ Validating appsscript.json files..."
        find . -name "appsscript.json" -exec python3 -m json.tool {} \; > /dev/null
        echo "âœ… All appsscript.json files are valid JSON"

        # Check for basic JavaScript syntax errors in main files
        echo "ðŸ“‹ Checking JavaScript syntax..."
        node <<'NODE'
        const fs = require('fs');
        const path = require('path');

        function checkJSFile(filePath) {
          try {
            const content = fs.readFileSync(filePath, 'utf8');
            // Basic syntax check - try to parse as function body
            new Function(content);
            console.log(`âœ… ${filePath} syntax OK`);
            return true;
          } catch (error) {
            console.log(`âŒ ${filePath} syntax error: ${error.message}`);
            return false;
          }
        }

        let allValid = true;
        const projects = ['process-refunds-exchanges', 'create-products-from-registration-info', 'leadership-discount-codes'];

        for (const project of projects) {
          const srcDir = path.join('projects', project, 'src');
          if (fs.existsSync(srcDir)) {
            const files = fs.readdirSync(srcDir).filter(f => f.endsWith('.gs'));
            for (const file of files) {
              if (!checkJSFile(path.join(srcDir, file))) {
                allValid = false;
              }
            }
          }
        }

        if (!allValid) {
          console.log('âŒ GAS compilation failed due to syntax errors');
          process.exit(1);
        }

        console.log('âœ… Google Apps Scripts compilation successful!');
        NODE

        # Skipping no-undef lint in CI; run locally instead for fuller context
        echo "â„¹ï¸ Skipping GAS no-undef lint in CI (run locally)"

        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Google Apps Scripts compilation check passed"

    - name: Check Lambda Functions Compilation
      id: lambda-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Lambda Functions compilation..."
        cd lambda-functions

        # Set up Python for Lambda functions
        python -m pip install --upgrade pip

        # Install root requirements for lambda functions
        pip install -r ../requirements.txt

        # Check each Lambda function directory
        echo "ðŸ“‹ Checking Lambda function syntax..."
        for dir in */; do
          echo "ðŸ” Checking ${dir}..."
          cd "$dir"

          # Check Python syntax
          python -m py_compile *.py 2>/dev/null || {
            echo "âŒ Syntax error in ${dir}"
            cd ..
            continue
          }

          # Try to import the lambda_function module
          python -c "
          import sys
          try:
              import lambda_function
              print('âœ… ${dir} imports successfully')
          except Exception as e:
              print('âŒ ${dir} import failed: {}'.format(e))
              sys.exit(1)
          " || {
            echo "âŒ Import error in ${dir}"
            cd ..
            continue
          }

          cd ..
        done

        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Lambda Functions compilation check passed"

    # Summary step
    - name: Compilation Summary
      env:
        BACKEND_STATUS: ${{ steps.backend-compile.outputs.success == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
        GAS_STATUS: ${{ steps.gas-compile.outputs.success == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
        LAMBDA_STATUS: ${{ steps.lambda-compile.outputs.success == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
        BACKEND_OK: ${{ steps.backend-compile.outputs.success }}
        GAS_OK: ${{ steps.gas-compile.outputs.success }}
        LAMBDA_OK: ${{ steps.lambda-compile.outputs.success }}
      run: |
        echo "ðŸ“Š Compilation Check Summary:"
        echo "Backend: ${BACKEND_STATUS}"
        echo "Google Apps Scripts: ${GAS_STATUS}"
        echo "Lambda Functions: ${LAMBDA_STATUS}"

        # Fail the job if any compilation failed
        if [ "${BACKEND_OK}" != "true" ] || [ "${GAS_OK}" != "true" ] || [ "${LAMBDA_OK}" != "true" ]; then
          echo "âŒ One or more compilation checks failed"
          exit 1
        fi

        echo "âœ… All compilation checks passed!"

  # Backend Tests - only run if backend compilation succeeded
  backend-tests:
    needs: compilation-check
    if: needs.compilation-check.outputs.backend-compiled == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up test environment variables
      run: |
        echo "SHOPIFY_URL_ADMIN_DOMAIN=test-store.myshopify.com" >> $GITHUB_ENV
        echo "SHOPIFY_TOKEN=test_token" >> $GITHUB_ENV
        echo "ENVIRONMENT=test" >> $GITHUB_ENV

    - name: Run Backend Tests
      run: |
        export SHOPIFY_URL_ADMIN_DOMAIN="test-store.myshopify.com"
        export SHOPIFY_TOKEN="test_token"
        export ENVIRONMENT="test"
        export SLACK_REFUNDS_BOT_TOKEN="test_slack_token"

        echo "ðŸ§ª Running backend tests..."
        python -m pytest tests/unit/ -v
        python -m pytest services/*/tests/ -v || true
        python -m pytest routers/tests/ -v || true
        python -m pytest tests/integration/ -v
        echo "âœ… Backend tests completed!"
      env:
        SHOPIFY_URL_ADMIN_DOMAIN: test-store.myshopify.com
        SHOPIFY_TOKEN: test_token
        ENVIRONMENT: test
        SLACK_REFUNDS_BOT_TOKEN: test_slack_token

  # Google Apps Scripts Tests - only run if GAS compilation succeeded
  gas-tests:
    needs: compilation-check
    if: needs.compilation-check.outputs.gas-compiled == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up Python (for JSON validation)
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Make test scripts executable
      run: |
        cd GoogleAppsScripts
        chmod +x tests/*.sh
        chmod +x projects/*/tests/*.sh

    - name: Run Google Apps Scripts Tests
      run: |
        cd GoogleAppsScripts
        echo "ðŸ§ª Running GAS tests..."
        # Run general tests
        ./tests/test_instructions.sh
        ./tests/test_sync_utilities.sh
        ./tests/test_clasp_helpers.sh
        # Run consolidated product creation tests
        cd projects/create-products-from-registration-info/tests
        node run_consolidated_tests.js
        cd -
        # Other projects
        ./projects/leadership-discount-codes/tests/test_leadership_discount_codes.sh
        ./projects/process-refunds-exchanges/tests/run_tests.sh
        echo "âœ… GAS tests completed!"

  # Lambda Tests - only run if Lambda compilation succeeded
  lambda-tests:
    needs: compilation-check
    if: needs.compilation-check.outputs.lambda-compiled == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Lambda Tests
      run: |
        cd lambda-functions
        echo "ðŸ§ª Running Lambda tests..."
        python3 tests/run_tests.py unit
        echo "âœ… Lambda tests completed!"


  # Base branch (main) checks - run only on PRs to compare against base
  compilation-check-base:
    if: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.base.sha != github.event.pull_request.head.sha }}
    runs-on: ubuntu-latest

    outputs:
      backend-compiled: ${{ steps.backend-compile.outputs.success }}
      gas-compiled: ${{ steps.gas-compile.outputs.success }}
      lambda-compiled: ${{ steps.lambda-compile.outputs.success }}

    steps:
    - uses: actions/checkout@v4
      with:
        # Check out the base branch (e.g., main)
        ref: ${{ github.event.pull_request.base.sha }}

    # Backend Compilation Check (base)
    - name: Check Backend Compilation (base)
      id: backend-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Backend compilation (base)..."
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        cd backend
        export SHOPIFY_STORE="test-store.myshopify.com"
        export SHOPIFY_TOKEN="test_token"
        export ENVIRONMENT="test"
        export SLACK_REFUNDS_BOT_TOKEN="test_slack_token"
        echo "ðŸ“‹ Checking Python syntax..."
        python -m py_compile config.py
        python -m py_compile main.py
        echo "ðŸ“‹ Checking module imports..."
        python -c "
        import sys
        sys.path.append('.')
        try:
            from config import settings
            print('âœ… Config module imports successfully')
            from main import app
            print('âœ… Main FastAPI app imports successfully')
            from services.orders.orders_service import OrdersService
            print('âœ… Orders service imports successfully')
            from services.slack.slack_service import SlackService
            print('âœ… Slack service imports successfully')
            try:
                from routers.refunds import router as refunds_router
                print('âœ… Refunds router imports successfully')
            except Exception as _e:
                print('â„¹ï¸ Refunds router not present (expected after refactor)')
            print('âœ… Backend compilation successful!')
        except Exception as e:
            print(f'âŒ Backend compilation failed: {e}')
            sys.exit(1)
        "
        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Backend compilation check (base) passed"

    - name: Check Google Apps Scripts Compilation (base)
      id: gas-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Google Apps Scripts compilation (base)..."
        cd GoogleAppsScripts
        npm install -g @google/clasp || true
        echo "ðŸ“‹ Validating appsscript.json files..."
        find . -name "appsscript.json" -exec python3 -m json.tool {} \; > /dev/null
        echo "âœ… All appsscript.json files are valid JSON"
        echo "ðŸ“‹ Checking JavaScript syntax..."
        node <<'NODE'
        const fs = require('fs');
        const path = require('path');
        function checkJSFile(filePath) {
          try {
            const content = fs.readFileSync(filePath, 'utf8');
            new Function(content);
            console.log(`âœ… ${filePath} syntax OK`);
            return true;
          } catch (error) {
            console.log(`âŒ ${filePath} syntax error: ${error.message}`);
            return false;
          }
        }
        let allValid = true;
        const projects = ['process-refunds-exchanges', 'create-products-from-registration-info', 'leadership-discount-codes'];
        for (const project of projects) {
          const srcDir = path.join('projects', project, 'src');
          if (fs.existsSync(srcDir)) {
            const files = fs.readdirSync(srcDir).filter(f => f.endsWith('.gs'));
            for (const file of files) {
              if (!checkJSFile(path.join(srcDir, file))) {
                allValid = false;
              }
            }
          }
        }
        if (!allValid) {
          console.log('âŒ GAS compilation failed due to syntax errors');
          process.exit(1);
        }
        console.log('âœ… Google Apps Scripts compilation successful!');
        NODE

        # Skipping no-undef lint in CI; run locally instead for fuller context
        echo "â„¹ï¸ Skipping GAS no-undef lint in CI (run locally)"
        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Google Apps Scripts compilation check (base) passed"

    - name: Check Lambda Functions Compilation (base)
      id: lambda-compile
      continue-on-error: true
      run: |
        echo "ðŸ” Checking Lambda Functions compilation (base)..."
        cd lambda-functions
        python -m pip install --upgrade pip
        pip install -r ../requirements.txt
        echo "ðŸ“‹ Checking Lambda function syntax..."
        for dir in */; do
          echo "ðŸ” Checking ${dir}..."
          cd "$dir"
          python -m py_compile *.py 2>/dev/null || { echo "âŒ Syntax error in ${dir}"; cd ..; continue; }
          python -c "
          import sys
          try:
              import lambda_function
              print('âœ… ${dir} imports successfully')
          except Exception as e:
              print('âŒ ${dir} import failed: {}'.format(e))
              sys.exit(1)
          " || { echo "âŒ Import error in ${dir}"; cd ..; continue; }
          cd ..
        done
        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Lambda Functions compilation check (base) passed"

  backend-tests-base:
    needs: compilation-check-base
    if: ${{ github.event_name == 'pull_request_target' && needs.compilation-check-base.outputs.backend-compiled == 'true' && github.event.pull_request.base.sha != github.event.pull_request.head.sha }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.sha }}
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Set up test environment variables
      run: |
        echo "SHOPIFY_STORE=test-store.myshopify.com" >> $GITHUB_ENV
        echo "SHOPIFY_TOKEN=test_token" >> $GITHUB_ENV
        echo "ENVIRONMENT=test" >> $GITHUB_ENV
    - name: Run Backend Tests (base)
      run: |
        export SHOPIFY_STORE="test-store.myshopify.com"
        export SHOPIFY_TOKEN="test_token"
        export ENVIRONMENT="test"
        export SLACK_REFUNDS_BOT_TOKEN="test_slack_token"
        echo "ðŸ§ª Running backend tests (base)..."
        python -m pytest tests/unit/ -v
        python -m pytest services/*/tests/ -v || true
        python -m pytest routers/tests/ -v || true
        python -m pytest tests/integration/ -v
        echo "âœ… Backend tests (base) completed!"

  gas-tests-base:
    needs: compilation-check-base
    if: ${{ github.event_name == 'pull_request_target' && needs.compilation-check-base.outputs.gas-compiled == 'true' && github.event.pull_request.base.sha != github.event.pull_request.head.sha }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.sha }}
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    - name: Set up Python (for JSON validation)
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Make test scripts executable
      run: |
        cd GoogleAppsScripts
        chmod +x tests/*.sh
        chmod +x projects/*/tests/*.sh || true
    - name: Run Google Apps Scripts Tests (base)
      run: |
        cd GoogleAppsScripts
        echo "ðŸ§ª Running GAS tests (base)..."
        ./tests/test_instructions.sh
        ./tests/test_sync_utilities.sh
        ./tests/test_clasp_helpers.sh
        cd projects/create-products-from-registration-info/tests
        node run_consolidated_tests.js
        cd -
        ./projects/leadership-discount-codes/tests/test_leadership_discount_codes.sh
        ./projects/process-refunds-exchanges/tests/run_tests.sh
        echo "âœ… GAS tests (base) completed!"

  lambda-tests-base:
    needs: compilation-check-base
    if: ${{ github.event_name == 'pull_request_target' && needs.compilation-check-base.outputs.lambda-compiled == 'true' && github.event.pull_request.base.sha != github.event.pull_request.head.sha }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.sha }}
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Run Lambda Tests (base)
      run: |
        cd lambda-functions
        echo "ðŸ§ª Running Lambda tests (base)..."
        python3 tests/run_tests.py unit
        echo "âœ… Lambda tests (base) completed!"